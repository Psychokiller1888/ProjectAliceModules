name: Skills Store Building

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      max-parallel: 4
    steps:
    - name: Get branch name
      id: get-branch
      uses: ypicard/get-branch-name-github-action@v1
    - name: create remote directories
      uses: garygrossgarten/github-action-ssh@release
      with:
        command: mkdir -p "${{ secrets.DOMAIN }}/${{ steps.get-branch.outputs.branch }}/store" "${{ secrets.DOMAIN }}/${{ steps.get-branch.outputs.branch }}/skills"
        host: ${{ secrets.DOMAIN }}
        username: ${{ secrets.USERNAME }}
        privateKey: ${{ secrets.SERVER_SSH_PRIV_KEY }}
    - uses: actions/checkout@v1
    - name: curl
      uses: wei/curl@v1
      with:
        args: -o 'test.json' --location --request GET 'https://api.rebrandly.com/v1/links' --header 'Content-Type: application/json' --header "apikey: ${{ secrets.RebrandlyApiKey }}"
    - name: combine install files
      run: |
        sudo apt-get install strace
        strace curl -o 'test.json' --location --verbose --request GET 'https://api.rebrandly.com/v1/links' --header 'Content-Type: application/json' --header "apikey: ${{ secrets.RebrandlyApiKey }}"
        python3 .github/workflows/store.py $clickCounts
    - name: get install files
      run: |
        cp PublishedSkills/*/*/*.install store/
        cd store
        for i in ./*.install; do mv -i "$i" "${i%.install}"; done
        cd ..
    - name: zip skills=
      run: |
        shopt -s nullglob
        for skillpath in PublishedSkills/*/*/*.install; do
        skillpath=$(dirname "${skillpath}")
        cd "${skillpath}"
        zip -r ../../../$(basename "${skillpath}") .
        cd ../../..
        done
    - name: deploy store
      uses: horochx/deploy-via-scp@master
      with:
        local: store/*
        remote: ${{ secrets.DOMAIN }}/${{ steps.get-branch.outputs.branch }}/store
        host: ${{ secrets.DOMAIN }}
        port: 22
        user: ${{ secrets.USERNAME }}
        key: ${{ secrets.SERVER_SSH_PRIV_KEY }}
    - name: deploy skills
      uses: horochx/deploy-via-scp@master
      with:
        local: "./*.zip"
        remote: ${{ secrets.DOMAIN }}/${{ steps.get-branch.outputs.branch }}/skills
        host: ${{ secrets.DOMAIN }}
        port: 22
        user: ${{ secrets.USERNAME }}
        key: ${{ secrets.SERVER_SSH_PRIV_KEY }}
